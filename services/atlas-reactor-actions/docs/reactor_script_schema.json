{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Reactor Script",
  "description": "JSON schema for reactor scripts - defines rules for reactor hit and trigger behavior",
  "type": "object",
  "required": [
    "reactorId",
    "hitRules",
    "actRules"
  ],
  "properties": {
    "reactorId": {
      "type": "string",
      "description": "The reactor classification ID (matches reactor WZ data ID, e.g., '2000', '2119000')"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of the reactor's purpose"
    },
    "hitRules": {
      "type": "array",
      "description": "Rules evaluated when reactor is hit by player - first matching rule wins",
      "items": {
        "$ref": "#/definitions/rule"
      }
    },
    "actRules": {
      "type": "array",
      "description": "Rules evaluated when reactor triggers (reaches final state) - first matching rule wins",
      "items": {
        "$ref": "#/definitions/rule"
      }
    }
  },
  "definitions": {
    "rule": {
      "type": "object",
      "description": "A single rule with conditions and operations",
      "required": [
        "id",
        "conditions",
        "operations"
      ],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the rule within this script"
        },
        "conditions": {
          "type": "array",
          "description": "Conditions that must ALL be true for this rule to match (AND logic). Empty array = always matches.",
          "items": {
            "$ref": "#/definitions/condition"
          }
        },
        "operations": {
          "type": "array",
          "description": "Operations to execute when this rule matches",
          "items": {
            "$ref": "#/definitions/operation"
          }
        }
      }
    },
    "condition": {
      "type": "object",
      "description": "A condition to evaluate",
      "required": [
        "type",
        "operator",
        "value"
      ],
      "properties": {
        "type": {
          "type": "string",
          "description": "Type of condition",
          "enum": [
            "reactor_state",
            "pq_custom_data"
          ]
        },
        "operator": {
          "type": "string",
          "description": "Comparison operator",
          "enum": ["=", ">", "<", ">=", "<=", "!="]
        },
        "value": {
          "type": "string",
          "description": "Value to compare against"
        },
        "step": {
          "type": "string",
          "description": "Custom data key name (required for pq_custom_data conditions)"
        }
      }
    },
    "operation": {
      "type": "object",
      "description": "An operation to execute",
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "type": "string",
          "description": "Type of operation",
          "enum": [
            "drop_items",
            "spawn_monster",
            "spray_items",
            "weaken_area_boss",
            "move_environment",
            "kill_all_monsters",
            "drop_message",
            "update_pq_state",
            "hit_reactor",
            "broadcast_pq_message"
          ]
        },
        "params": {
          "type": "object",
          "description": "Parameters for the operation",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "drop_items" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "properties": {
                  "meso": {
                    "type": "string",
                    "description": "Whether to drop meso (true/false)"
                  },
                  "minMeso": {
                    "type": "string",
                    "description": "Minimum meso multiplier"
                  },
                  "maxMeso": {
                    "type": "string",
                    "description": "Maximum meso multiplier"
                  },
                  "mesoRange": {
                    "type": "string",
                    "description": "Meso range multiplier"
                  },
                  "item": {
                    "type": "string",
                    "description": "Item flag (1 = drop items)"
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "spawn_monster" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "required": ["monsterId"],
                "properties": {
                  "monsterId": {
                    "type": "string",
                    "description": "Monster ID to spawn"
                  },
                  "count": {
                    "type": "string",
                    "description": "Number of monsters to spawn (default: 1)"
                  },
                  "x": {
                    "type": "string",
                    "description": "X position override (default: reactor X)"
                  },
                  "y": {
                    "type": "string",
                    "description": "Y position override (default: reactor Y)"
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "weaken_area_boss" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "required": ["monsterId", "message"],
                "properties": {
                  "monsterId": {
                    "type": "string",
                    "description": "Boss monster ID to weaken"
                  },
                  "message": {
                    "type": "string",
                    "description": "Message to display when boss is weakened"
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "move_environment" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "required": ["name", "value"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Environment object name"
                  },
                  "value": {
                    "type": "string",
                    "description": "New environment state value"
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "drop_message" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "required": ["message"],
                "properties": {
                  "type": {
                    "type": "string",
                    "description": "Message type (default: 5 for pink text)"
                  },
                  "message": {
                    "type": "string",
                    "description": "Message to display to player"
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "update_pq_state" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "properties": {
                  "updates": {
                    "type": "string",
                    "description": "Comma-separated key=value pairs to set (e.g., 'seeds=3,complete=true')"
                  },
                  "increments": {
                    "type": "string",
                    "description": "Comma-separated key names to increment by 1 (e.g., 'seeds,kills')"
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "hit_reactor" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "required": ["reactorName"],
                "properties": {
                  "reactorName": {
                    "type": "string",
                    "description": "Name of the reactor to hit (resolved via REST query)"
                  }
                }
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "broadcast_pq_message" } }
          },
          "then": {
            "properties": {
              "params": {
                "type": "object",
                "required": ["message"],
                "properties": {
                  "type": {
                    "type": "string",
                    "description": "Message type (default: PINK_TEXT)"
                  },
                  "message": {
                    "type": "string",
                    "description": "Message to broadcast to all PQ members"
                  }
                }
              }
            }
          }
        }
      ]
    }
  }
}
